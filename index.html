<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thư viện Sách</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap&subset=vietnamese" rel="stylesheet">
</head>
<body class="is-loading">
    <div class="vertical-navbar">
        <div class="sidebar-header fade-element" style="--delay: 0.1s;">
            <a href="/" class="navbar-logo">Library</a>
        </div>
        <a href="/" class="nav-item active fade-element" style="--delay: 0.2s;">
            <i class='bx bx-home-alt'></i>
        </a>
        <a href="#book-list-section" class="nav-item fade-element" style="--delay: 0.3s;">
            <i class='bx bx-book'></i>
        </a>
        <a href="#" class="nav-item fade-element" style="--delay: 0.4s;">
            <i class='bx bx-code-alt'></i>
        </a>
        <a href="#contact-section" class="nav-item fade-element" style="--delay: 0.5s;">
            <i class='bx bx-envelope'></i>
        </a>
    </div>

    <div class="content-wrapper">
        <div class="top-header-bar">
            <div class="top-right-actions">
                <a href="login_page.html" class="navbar-login-btn main-action-btn fade-element" style="--delay: 0.2s;">
                    <i class='bx bx-user-circle'></i>
                    LOG IN
                </a>
                <a href="#book-list-section" class="main-action-btn fade-element" style="--delay: 0.3s;">
                    MƯỢN SÁCH NGAY
                </a>
            </div>
        </div>
        <div id="user-info-display"></div>
        <div class="main-content-wrapper">
            <div class="hero-text-block">
                <h1 class="main-title">
                    <span class="fade-element" style="--delay: 0.4s;">
                        Nơi ươm mầm<span class="highlight-orange">Tư</span>
                    </span>
                    <br><span class="fade-element" style="--delay: 0.6s;">
                        tưởng, tạo dựng
                    </span>
                    <br><span class="fade-element" style="--delay: 0.8s;">
                        đổi mới.
                    </span>
                </h1>
            </div>

            <div class="sub-text-block">
                <p class="fade-element" style="--delay: 1.0s;">
                    Chúng tôi cung cấp tài nguyên thiết yếu giúp các nhà nghiên cứu, sinh viên phát triển tưởng vọng và biến chúng thành hiện thực.
                </p>
                <a href="#book-list-section" class="intro-call-btn centered-cta fade-element" style="--delay: 1.2s;">
                    <i class='bx bx-book-open'></i>
                    MƯỢN SÁCH NGAY
                </a>
            </div>
        </div>

        <div class="footer-info fade-element" style="--delay: 1.4s;">
            <p>Nhóm 1</p>
            <p>Hanoi, Vietnam 12:00 AM</p>
        </div>
        <div class="container book-catalog-section" id="book-list-section">
            <h2 class="fade-element" style="--delay: 1.5s;">Danh mục sách có sẵn</h2>
            <p class="fade-element" style="--delay: 1.6s;">Vui lòng chọn một cuốn sách để mượn:</p>
            
            <ul class="book-list">
                <li class="book-item fade-element" style="--delay: 1.7s;"><a href="borrow.html?bookId=101">Lập trình C++ Nâng cao</a></li>
                <li class="book-item fade-element" style="--delay: 1.8s;"><a href="borrow.html?bookId=102">Cấu trúc dữ liệu và Giải thuật</a></li>
                <li class="book-item fade-element" style="--delay: 1.9s;"><a href="borrow.html?bookId=103">Thiết kế hệ thống cơ bản</a></li>
                <li class="book-item fade-element" style="--delay: 2.0s;"><a href="borrow.html?bookId=104">OOP với C++</a></li>
                <li class="book-item fade-element" style="--delay: 2.1s;"><a href="borrow.html?bookId=105">Một cuốn sách có tên rất dài</a></li>
                <li class="book-item fade-element" style="--delay: 2.2s;"><a href="borrow.html?bookId=106">Sách 6</a></li>
            </ul>
            
        </div>
    </div>

    <div id="contact-section" style="height: 1px;"></div>

    <script src="session.js"></script>
    
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.body.classList.remove('is-loading'); 
            Auth.updateNavbar();

            async function fetchAndUpdateBookStatus() {
                try {
                    const response = await fetch('/get-all-books');
                    if (!response.ok) throw new Error('Failed to fetch status');
                    
                    const booksData = await response.json();
                    const bookStatusMap = new Map();
                    booksData.forEach(book => bookStatusMap.set(book.id, book));

                    const bookLinks = document.querySelectorAll('.book-list .book-item a');

                    bookLinks.forEach(link => {
                        const href = link.getAttribute('href');
                        const urlParams = new URLSearchParams(href.split('?')[1]);
                        const bookId = urlParams.get('bookId');
                        const book = bookStatusMap.get(bookId);

                        if (book) {
                            link.innerHTML = `
                                <div class="book-cover-placeholder">
                                    <i class='bx ${book.iconName || 'bx-book'}'></i>
                                </div>
                                <div class="book-info">
                                    <h3 class="book-title">${book.title}</h3>
                                    <p class="book-author">${book.author}</p>
                                </div>
                            `;

                            if (!book.isAvailable) {
                                link.classList.add('disabled');
                                link.href = '#'; 
                                link.onclick = (e) => e.preventDefault();
                            }
                        } else {
                            link.innerHTML = `
                                <div class="book-cover-placeholder">
                                    <i class='bx bx-error-alt'></i>
                                </div>
                                <div class="book-info">
                                    <h3 class="book-title">Book Not Found</h3>
                                    <p class="book-author">Unknown</p>
                                </div>
                            `;
                            link.classList.add('disabled');
                        }
                    });

                } catch (error) {
                    console.error('Error updating book status:', error);
                    const bookList = document.querySelector('.book-list');
                    if(bookList) bookList.innerHTML = "<p>Error loading books. Please try refreshing.</p>";
                }
            }
            
            fetchAndUpdateBookStatus();

            // Navbar magnification effect
            const navItems = document.querySelectorAll('.vertical-navbar .nav-item');
            const navbar = document.querySelector('.vertical-navbar');
            const MAX_SCALE = 1.6;
            const MAX_DISTANCE = 150;

            function calculateScale(mouseX, mouseY) {
                navItems.forEach(item => {
                    const rect = item.getBoundingClientRect();
                    const itemCenterX = rect.left + rect.width / 2;
                    const itemCenterY = rect.top + rect.height / 2;
                    const distance = Math.sqrt(
                        Math.pow(mouseX - itemCenterX, 2) + 
                        Math.pow(mouseY - itemCenterY, 2)
                    );

                    let scale = 1;
                    if (distance < MAX_DISTANCE) {
                        const normalizedDistance = distance / MAX_DISTANCE;
                        const closenessFactor = 1 - normalizedDistance;
                        scale = 1 + (MAX_SCALE - 1) * closenessFactor;
                    }
                    item.style.transition = 'transform 0.1s ease-out';
                    item.style.transform = `scale(${scale})`;
                });
            }

            document.addEventListener('mousemove', (e) => {
                calculateScale(e.clientX, e.clientY);
            });

            navbar.addEventListener('mouseleave', () => {
                navItems.forEach(item => {
                    item.style.transition = 'transform 0.3s ease';
                    item.style.transform = 'scale(1)';
                });
            });
        });
    </script>
    </body>
</html>