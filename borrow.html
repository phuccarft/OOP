<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Borrowing Form</title>
    <link rel="stylesheet" href="style.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap&subset=vietnamese" rel="stylesheet">
</head>
<body class="borrow-page">
    <div class="borrow-page-wrapper">
        <div class="borrow-card">
            <div class="card-left"></div>
            <div class="card-right">
                <h3 id="book-title">Đang tải tên sách...</h3>
                <h1>BOOK BORROWING FORM</h1>
                
                <form id="borrow-form">
                    <div>
                        <label for="member-name">Full name:</label>
                        <input type="text" id="member-name" name="memberName" placeholder="Enter your full name..." required>
                    </div>
                    <div>
                        <label for="member-id">ID:</label>
                        <input type="text" id="member-id" name="memberId" placeholder="Enter your member ID..." required>
                    </div>
                    <div>
                        <label for="member-email">Email:</label>
                        <input type="text" id="member-email" name="memberEmail" placeholder="Enter your registered email..." required>
                    </div>
                    <div>
                        <label>Member type:</label>
                        <div class="radio-group">
                            <input type="radio" id="member-student" name="memberType" value="student" checked>
                            <label for="member-student">Student</label>
                            <input type="radio" id="member-teacher" name="memberType" value="teacher">
                            <label for="member-teacher">Teacher</label>
                        </div>
                    </div>
                    <button type="submit">Submit</button>
                </form>

                <div id="result" style="display:none;"></div>

                <div class="signup-banner">
                    Chưa có tài khoản? <a href="login_page.html">Đăng nhập</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Session Manager -->
    <script src="session.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('bookId');

        const bookData = {
            '101': 'Lập trình C++ Nâng cao',
            '102': 'Cấu trúc dữ liệu và Giải thuật',
            '103': 'Thiết kế hệ thống căn bản',
            '104': 'OOP với C++',
            '105': 'Một cuốn sách có tên rất dài',
            '106': 'Sách 6'
        };

        const bookTitleElement = document.getElementById('book-title');
        const title = bookData[bookId] || 'Sách không xác định';
        bookTitleElement.textContent = title;

        // AUTO-FILL form if user is logged in
        document.addEventListener('DOMContentLoaded', () => {
            const user = SessionManager.getCurrentUser();
            
            if (user) {
                // Fill form with user data
                document.getElementById('member-name').value = user.name;
                document.getElementById('member-id').value = user.id;
                document.getElementById('member-email').value = user.email;
                
                // Set correct member type
                if (user.type === 'student') {
                    document.getElementById('member-student').checked = true;
                } else if (user.type === 'teacher') {
                    document.getElementById('member-teacher').checked = true;
                }

                // Make ID field readonly (can't borrow for someone else)
                document.getElementById('member-id').readOnly = true;
                document.getElementById('member-id').style.backgroundColor = '#eee';
            }
        });

        const borrowForm = document.getElementById('borrow-form');
        const resultDiv = document.getElementById('result');

        borrowForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const submitButton = borrowForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Đang xử lý...';

            const memberName = document.getElementById('member-name').value;
            const memberId = document.getElementById('member-id').value;
            const memberEmail = document.getElementById('member-email').value;
            const memberType = document.querySelector('input[name="memberType"]:checked').value;

            const dataToSend = {
                bookId: bookId,
                memberName: memberName,
                memberId: memberId,
                memberEmail: memberEmail,
                memberType: memberType
            };

            fetch('/borrow-book', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Server Error: ${response.statusText} - ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                if(data.success) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit';
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'success result-clean';

                    const memberTypeText = data.memberType === 'student' ? 'Student' : 'Teacher';
                    const borrowFeeValue = parseInt(data.borrowFee);
                    const formattedBorrowFee = new Intl.NumberFormat('vi-VN').format(borrowFeeValue);

                    const userParams = new URLSearchParams({
                        memberName: data.memberName,
                        memberId: memberId,
                        memberEmail: memberEmail,
                        memberType: data.memberType,
                        bookTitle: data.bookTitle || bookData[bookId] || 'Unknown Book',
                        bookId: data.bookId,
                        dueDate: data.dueDate,
                        borrowFee: data.borrowFee,
                        lateFeeRate: data.lateFeeRate
                    });

                    resultDiv.innerHTML = `
                        <div class="result-clean success">
                            <div class="status-header">
                                <i class='bx bx-check-circle'></i>
                                <p class="status-title">BOOK BORROWED</p>
                                <p class="status-subtitle">The book is now reserved in your name.</p>
                            </div>
                            <div class="order-summary-card">
                                <div class="summary-item">
                                    <span class="summary-label">Member:</span>
                                    <span class="summary-value">${data.memberName} (${memberTypeText})</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Book Title:</span>
                                    <span class="summary-value">${data.bookTitle}</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Book ID:</span>
                                    <span class="summary-value">${data.bookId}</span>
                                </div>
                            </div>
                            <div class="fee-details-card">
                                <h2 class="card-title-small">Fee & Return Summary</h2>
                                <div class="summary-detail-line">
                                    <span class="detail-label">Borrow Fee:</span>
                                    <span class="detail-value">${formattedBorrowFee} VND</span>
                                </div>
                                <div class="summary-detail-line highlight-date">
                                    <span class="detail-label">DUE DATE:</span>
                                    <span class="detail-value highlight">${data.dueDate}</span>
                                </div>
                                <div class="summary-detail-line">
                                    <span class="detail-label">Late Fee / Day:</span>
                                    <span class="detail-value">${data.lateFeeRate} VND</span>
                                </div>
                                <p class="status-footer">
                                    Your book is confirmed and due by the highlighted date.
                                </p>
                            </div>
                            <div class="result-buttons">
                                <button id="home-button" type="button" class="return-button home-button">
                                    <i class='bx bx-home'></i>
                                    Back to Home
                                </button>
                                <button id="user-page-button" type="button" class="return-button account-button">
                                    <i class='bx bx-user'></i>
                                    Go to My Account
                                </button>
                            </div>
                        </div>
                    `;

                    borrowForm.style.display = 'none';

                    document.getElementById('home-button').addEventListener('click', () => {
                        window.location.href = '/';
                    });

                    document.getElementById('user-page-button').addEventListener('click', () => {
                        window.location.href = `user_page.html?${userParams.toString()}`;
                    });
                } else {
                    throw new Error(data.message || 'Unknown error from server');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitButton.disabled = false;
                submitButton.textContent = 'Submit';
                resultDiv.style.display = 'block';
                resultDiv.className = 'error result-clean';
                resultDiv.innerHTML = `<p><strong>Error:</strong> ${error.message}</p>`;
            });
        });
    </script>
</body>
</html>